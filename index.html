<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lag deltakerliste</title>
    <link rel="stylesheet" href="style.css"> <!-- Inkluder CSS-filen -->
    <link rel="icon" href="icon.ico" type="image/x-icon"> <!-- Legg til ikon -->
    <script src="xlsx.full.min.js"></script> <!-- XLSX.js er et JavaScript-bibliotek som lar deg lese og skrive Excel-filer i nettleseren. -->
    <script src="https://alcdn.msauth.net/browser/2.32.0/js/msal-browser.min.js"></script> <!-- Microsoft Authentication Library (MSAL) for JavaScript. It is used to handle authentication and authorization in web applications that integrate with Microsoft services, such as Azure Active Directory (Azure AD) or Microsoft Graph API.-->
    <script src="jspdf.umd.min.js"></script> <!-- Allows you to create PDF files programmatically. -->
    <script src="jspdf.plugin.autotable.min.js"></script> <!-- Allows you to create and format tables in PDFs. -->
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
      </script>
      <script defer src="/_vercel/insights/script.js"></script>
    <style>
        #username {
            position: absolute;
            top: 10px;
            right: 10px;
        }
        #logoutButton {
            position: absolute;
            top: 10px;
            right: 10px;
        }

    </style>
</head>
<body>
    <div class="driftsmelding">Nettstedet oppdateres de neste timene. Løsningen kan oppleves litt uvanlig.</div>
    <header class="header">
        <div class="header-left">
            <img src="vfk_logo.png" alt="Vestfold fylkeskommune logo" class="fk-logo">
            <div>
                <!-- <div class="fk-title">Vestfold</div> -->
                <!-- <div class="fk-subtitle">FYLKESKOMMUNE</div> -->
            </div>
        </div>
        <div class="header-center">
            <!-- <img src="vfk_logo.png" alt="VFK Logo" class="dust-logo"> -->
            <span style="text-align: center;" class="dust-title">Lag deltakerliste</span>
        </div>
        <div class="header-right">
            <div class="user-info">
                <div class="user-row">
                    <span class="user-name" id="userName">Ikke pålogget</span><button id="logoutButton" title="Logg ut">×</button>
                </div>
                <a href="https://forms.office.com/e/FiSVZRZLVa" target="_blank" class="button">Send tilbakemelding</a>
                <span class="calendar-label" id="openCalendarDropdown">Åpne annen kalender</span>
                <div class="calendar-dropdown-container" id="calendarDropdown">
                    <button class="calendar-dropdown-close" id="closeCalendarDropdown" title="Lukk">×</button>
                    <label for="manualSharedMailbox">Skriv inn delt postboks</label>
                    <input type="text" id="manualSharedMailbox" placeholder="E-postadressen til kalenderen" autocomplete="off" />
                    <div class="mailbox-suggestion" id="mailboxSuggestion">
                        <div class="mailbox-suggestion-title">Forslag</div>
                        <span class="mailbox-suggestion-item" id="suggestionSkiringssal">tbg-mr-skiringssal@vestfoldfylke.no</span>
                        <span class="mailbox-suggestion-item" id="suggestionSentralbord">sentralbord@vestfoldfylke.no</span>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <button id="loginButton">Logg inn med Microsoft</button>
    <h1 id="datePickerLabel">Velg dato</h1>
    <input type="date" id="datePicker" />
    <button id="fetchEventsButton">Hent kalenderhendelser</button>
    <div id="eventList"></div>
    <br>
    <div id="meetingDetails">
        <h2>Møteinformasjon</h2>
        <p><strong>Tittel:</strong> <span id="meetingTitle">Ingen tittel</span></p>
        <p><strong>Dato:</strong> <span id="meetingDate">Ukjent dato</span></p>
        <p><strong>Starttid:</strong> <span id="meetingStartTime">Ukjent starttid</span></p>
        <p><strong>Sluttid:</strong> <span id="meetingEndTime">Ukjent sluttid</span></p>
        <p><strong>Sted:</strong> <span id="meetingLocation">Ikke spesifisert</span></p>
        <p><strong>Arrangør:</strong> <span id="meetingOrganizer">Ikke spesifisert</span></p>
        <p><strong>Inviterte:</strong> <span id="totalCount">0</span></p>
        <p><strong>Akseptert:</strong> <span id="acceptedCount">0</span></p>
        <p><strong>Ikke akseptert:</strong> <span id="notAcceptedCount">0</span></p>
    </div>
    <div id="statusMessage"></div>
    <div class="button-container">
        <button id="exportTableButton" title="Last ned deltakerlisten som Excel-fil. Filen er formatert for import til besøksregistreringssystemet onVisit">Eksporter tabell til Excel</button>
        <button id="printParticipantListButton" title="Skriv ut deltakerlisten som PDF">Skriv ut deltakerliste</button>
        <button id="updateStatusButton" title="Oppdater status for deltakerne fra kalenderen">Oppdater status</button>
    </div>
    <div id="previewTable"></div>
    <div id="participantSummary"></div>

    <script src="env.js"></script>
    <script type="module">
        import { clientId, authority, redirectUri } from './config.js';
        window.envConfig = { clientId, authority, redirectUri };
    </script>
    <script>
        let msalInstance; // Definer msalInstance som en global variabel

        async function loadEnvVariables() {
            try {
                const msalConfig = {
                    auth: {
                        clientId: window.envConfig.clientId,
                        authority: window.envConfig.authority,
                        redirectUri: window.envConfig.redirectUri
                    }
                };

                const graphConfig = {
                    graphMeEndpoint: 'https://graph.microsoft.com/v1.0/me',
                    graphEventsEndpoint: 'https://graph.microsoft.com/v1.0/me/events'
                };

                initializeApp(msalConfig, graphConfig);
            } catch (error) {
                console.error('Kunne ikke laste miljøvariabler:', error);
            }
        }

        function initializeApp(msalConfig, graphConfig) {
            msalInstance = new msal.PublicClientApplication(msalConfig);
            const loginButton = document.getElementById('loginButton');
            loginButton.disabled = true;

            console.log('MSAL Configuration:', msalConfig);

            // Handle redirect response
            msalInstance.handleRedirectPromise().then((response) => {
                if (response) {
                    msalInstance.setActiveAccount(response.account);
                }
                const activeAccount = msalInstance.getActiveAccount();
                if (activeAccount) {
                    handlePostLogin(msalInstance, graphConfig);
                } else {
                    loginButton.style.display = 'block';
                }
                loginButton.disabled = false;
            }).catch((error) => {
                loginButton.disabled = false;
            });

            // Attempt SSO with loginHint if no active account is found
            const accounts = msalInstance.getAllAccounts();
            const loginHint = accounts.length > 0 ? accounts[0].username : '';

            msalInstance.ssoSilent({
                scopes: ['User.Read', 'Calendars.Read'],
                loginHint: loginHint
            }).then((response) => {
                msalInstance.setActiveAccount(response.account);
                handlePostLogin(msalInstance, graphConfig);
            }).catch((error) => {
                // Håndter samtykke/tilgangsfeil
                if (error instanceof msal.InteractionRequiredAuthError || error.errorCode === 'consent_required' || error.errorCode === 'interaction_required') {
                    msalInstance.loginRedirect({
                        scopes: ['User.Read', 'Calendars.Read'],
                        prompt: 'consent', // Tving samtykke
                        loginHint: loginHint
                    });
                } else {
                    loginButton.style.display = 'block';
                    loginButton.disabled = false;
                }
            });

            loginButton.addEventListener('click', () => {
                msalInstance.loginRedirect({
                    scopes: ['User.Read', 'Calendars.Read']
                    // prompt: 'consent' // Fjernet for å unngå tvungen samtykke hver gang
                });
            });

            document.getElementById('logoutButton').addEventListener('click', () => {
                msalInstance.logoutRedirect();
            });
        }

        async function fetchSharedMailboxes(token) {
            // Hent grupper brukeren er medlem av
            const url = 'https://graph.microsoft.com/v1.0/me/memberOf?$select=id,displayName,@odata.type';
            const response = await fetch(url, {
                headers: { Authorization: `Bearer ${token}` }
            });
            const data = await response.json();
            // Filtrer kun grupper
            const groups = (data.value || []).filter(obj => obj['@odata.type'] === '#microsoft.graph.group');
            // Hent e-post for hver gruppe og filtrer kun delte postbokser
            const mailboxes = [];
            for (const group of groups) {
                const groupDetailsUrl = `https://graph.microsoft.com/v1.0/groups/${group.id}?$select=id,displayName,mail,groupTypes`;
                const groupDetailsResp = await fetch(groupDetailsUrl, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                if (groupDetailsResp.ok) {
                    const groupDetails = await groupDetailsResp.json();
                    // Filtrer kun delte postbokser: må ha mail, ikke være Microsoft 365-gruppe (groupTypes må være tom eller ikke inneholde 'Unified'), og ikke onmicrosoft.com
                    if (
                        groupDetails.mail &&
                        (!groupDetails.groupTypes || !groupDetails.groupTypes.includes('Unified')) &&
                        !groupDetails.mail.endsWith('@onmicrosoft.com')
                    ) {
                        mailboxes.push({ id: groupDetails.id, displayName: groupDetails.displayName, mail: groupDetails.mail });
                    }
                }
            }
            return mailboxes;
        }

        async function fetchGroupCalendars(token, groupId) {
            // Hent kalendere for en gruppe (delt postboks)
            const url = `https://graph.microsoft.com/v1.0/groups/${groupId}/calendar`;
            const response = await fetch(url, {
                headers: { Authorization: `Bearer ${token}` }
            });
            if (response.ok) {
                const data = await response.json();
                return [{ id: groupId, name: data.name || 'Delt postboks', group: true }];
            }
            return [];
        }

        async function fetchCalendars(token) {
            // Hent alle kalendere brukeren har tilgang til
            const url = 'https://graph.microsoft.com/v1.0/me/calendars';
            const response = await fetch(url, {
                headers: { Authorization: `Bearer ${token}` }
            });
            const data = await response.json();
            return data.value || [];
        }

        async function populateCalendarSelect() {
            const account = msalInstance.getActiveAccount();
            let tokenResponse;
            try {
                tokenResponse = await msalInstance.acquireTokenSilent({
                    scopes: ['Calendars.Read', 'Group.Read.All'],
                    account: account
                });
            } catch (error) {
                if (error instanceof msal.InteractionRequiredAuthError || error.errorCode === 'consent_required' || error.errorCode === 'interaction_required') {
                    await msalInstance.loginRedirect({
                        scopes: ['User.Read', 'Calendars.Read', 'Group.Read.All'],
                        prompt: 'consent',
                        loginHint: account?.username || ''
                    });
                    return;
                } else {
                    throw error;
                }
            }
            const calendars = await fetchCalendars(tokenResponse.accessToken);
            const sharedMailboxes = await fetchSharedMailboxes(tokenResponse.accessToken);
            let sharedCalendars = [];
            for (const mailbox of sharedMailboxes) {
                const groupCals = await fetchGroupCalendars(tokenResponse.accessToken, mailbox.id);
                sharedCalendars = sharedCalendars.concat(groupCals.map(cal => ({
                    id: cal.id,
                    name: `${mailbox.displayName} (delt postboks)`,
                    group: true
                })));
            }
            const select = document.getElementById('calendarSelect');
            select.innerHTML = '';
            calendars.forEach(cal => {
                const option = document.createElement('option');
                option.value = cal.id;
                option.textContent = cal.name;
                select.appendChild(option);
            });
            sharedCalendars.forEach(cal => {
                const option = document.createElement('option');
                option.value = cal.id;
                option.textContent = cal.name;
                option.setAttribute('data-group', 'true');
                select.appendChild(option);
            });
            select.style.display = 'block';
            selectedCalendarId = select.value;
            select.addEventListener('change', function() {
                selectedCalendarId = this.value;
            });
        }

        function handlePostLogin(msalInstance, graphConfig) {
            const activeAccount = msalInstance.getActiveAccount();
            if (activeAccount) {
                console.log(`Logget inn som ${activeAccount.username}`);
                document.getElementById('userName').textContent = activeAccount.username; // Oppdater brukernavn
                document.getElementById('fetchEventsButton').style.display = 'inline-block';
                document.getElementById('datePicker').style.display = 'inline-block';
                document.getElementById('datePickerLabel').style.display = 'block'; // Show "Velg dato" text
                document.getElementById('logoutButton').style.display = 'inline-block'; // Vis logg ut-knappen
                document.getElementById('loginButton').style.display = 'none'; // Skjul logg inn-knappen
                document.querySelector('.button-container').style.display = 'flex'; // Show button container
            }
            populateCalendarSelect();
        }

        async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response.json();
                    } else if (response.status === 429 && i < retries - 1) {
                        const retryAfter = response.headers.get('Retry-After');
                        const waitTime = retryAfter ? parseInt(retryAfter, 10) * 1000 : delay * (2 ** i);
                        console.warn(`Rate limit hit. Retrying after ${waitTime}ms...`);
                        await new Promise(resolve => setTimeout(resolve, waitTime));
                    } else {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                } catch (error) {
                    if (i === retries - 1) {
                        throw error;
                    }
                    console.warn(`Retrying due to error: ${error.message}`);
                    await new Promise(resolve => setTimeout(resolve, delay * (2 ** i)));
                }
            }
        }

        document.getElementById('fetchEventsButton').addEventListener('click', async () => {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = '';
            statusMessage.style.display = 'none';
            try {
                const selectedDate = document.getElementById('datePicker').value;
                if (!selectedDate) {
                    throw new Error('Velg en dato først.');
                }
                const selectedDateStart = new Date(selectedDate);
                selectedDateStart.setHours(0, 0, 0, 0);
                const selectedDateEnd = new Date(selectedDate);
                selectedDateEnd.setHours(23, 59, 59, 999);
                const account = msalInstance.getActiveAccount();
                let tokenResponse;
                try {
                    tokenResponse = await msalInstance.acquireTokenSilent({
                        scopes: ['Calendars.Read', 'Group.Read.All'],
                        account: account
                    });
                } catch (error) {
                    if (error instanceof msal.InteractionRequiredAuthError || error.errorCode === 'consent_required' || error.errorCode === 'interaction_required') {
                        await msalInstance.loginRedirect({
                            scopes: ['User.Read', 'Calendars.Read', 'Group.Read.All'],
                            prompt: 'consent',
                            loginHint: account?.username || ''
                        });
                        return;
                    } else {
                        throw error;
                    }
                }
                // Sjekk om manuell delt postboks er angitt
                const manualSharedMailbox = document.getElementById('manualSharedMailbox').value.trim();
                let graphEventsEndpoint;
                if (manualSharedMailbox) {
                    graphEventsEndpoint = `https://graph.microsoft.com/v1.0/users/${manualSharedMailbox}/calendar/calendarView`;
                } else {
                    graphEventsEndpoint = 'https://graph.microsoft.com/v1.0/me/calendarview';
                }
                const filterQuery = `startDateTime=${selectedDateStart.toISOString()}&endDateTime=${selectedDateEnd.toISOString()}`;
                const eventsEndpoint = `${graphEventsEndpoint}?${filterQuery}&$top=100`;
                let events = [];
                let nextLink = eventsEndpoint;
                while (nextLink) {
                    const eventsData = await fetchWithRetry(nextLink, {
                        headers: { Authorization: `Bearer ${tokenResponse.accessToken}` }
                    });
                    events = events.concat(eventsData.value);
                    nextLink = eventsData['@odata.nextLink'] || null;
                }

                console.log('Filtrerte hendelser:', events);

                if (events.length === 0) {
                    document.getElementById('eventList').innerHTML = '<p>Ingen hendelser funnet for valgt dato.</p>';
                    document.getElementById('eventList').style.display = 'block';
                } else {
                    const headers = ['Velg', 'Tittel', 'Dato', 'Starttid', 'Sluttid', 'Sted', 'Arrangør'];
                    const rows = events.map(event => {
                        const isAllDay = event.isAllDay || (!event.start.dateTime && event.start.date);
                        const eventStart = isAllDay ? new Date(event.start.date) : new Date(event.start.dateTime);
                        const eventEnd = isAllDay ? new Date(event.end.date) : new Date(event.end.dateTime);

                        // Adjust times by adding 2 hours for non-all-day events
                        if (!isAllDay) {
                            eventStart.setHours(eventStart.getHours() + 2);
                            eventEnd.setHours(eventEnd.getHours() + 2);
                        }

                        console.log('Hendelsesdetaljer:', {
                            Tittel: event.subject,
                            Start: eventStart,
                            Slutt: eventEnd,
                            Sted: event.location?.displayName,
                            Arrangør: event.organizer.emailAddress.name,
                            Heldag: isAllDay
                        });

                        // Ensure heldagshendelser are displayed correctly
                        return `
                            <tr>
                                <td><input type="radio" name="event" value="${event.id}" /></td>
                                <td>${event.subject || 'Ingen tittel'}</td>
                                <td>${eventStart.toLocaleDateString('no-NO')}</td>
                                <td>${isAllDay ? 'Heldag' : eventStart.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</td>
                                <td>${isAllDay ? 'Heldag' : eventEnd.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</td>
                                <td>${event.location?.displayName || 'Ikke spesifisert'}</td>
                                <td>${event.organizer.emailAddress.name}</td>
                            </tr>
                        `;
                    }).join('');

                    document.getElementById('eventList').innerHTML = `
                        <table border="1" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr>${headers.map(header => `<th>${header}</th>`).join('')}</tr>
                            </thead>
                            <tbody>${rows}</tbody>
                        </table>
                    `;
                    document.getElementById('eventList').style.display = 'block';
                }
            } catch (error) {
                const statusMessage = document.getElementById('statusMessage');
                if (error.message.includes('status: 404')) {
                    statusMessage.textContent = 'Fant ikke kalenderen for den angitte postboksen, eller du har ikke tilgang. Sjekk e-postadressen og tilgang.';
                    statusMessage.style.display = 'block';
                } else {
                    statusMessage.textContent = 'Feil ved henting av kalenderhendelser: ' + error.message;
                    statusMessage.style.display = 'block';
                }
                console.error('Feil ved henting av kalenderhendelser:', error.message);
            }
        });

        document.getElementById('eventList').addEventListener('change', async () => {
            try {
                const selectedEvent = document.querySelector('input[name="event"]:checked');
                if (!selectedEvent) {
                    throw new Error('Velg en kalenderhendelse først.');
                }
                const selectedEventId = selectedEvent.value;
                const account = msalInstance.getActiveAccount();
                let tokenResponse;
                try {
                    tokenResponse = await msalInstance.acquireTokenSilent({
                        scopes: ['Calendars.Read', 'Group.Read.All'],
                        account: account
                    });
                } catch (error) {
                    if (error instanceof msal.InteractionRequiredAuthError || error.errorCode === 'consent_required' || error.errorCode === 'interaction_required') {
                        await msalInstance.loginRedirect({
                            scopes: ['User.Read', 'Calendars.Read', 'Group.Read.All'],
                            prompt: 'consent',
                            loginHint: account?.username || ''
                        });
                        return;
                    } else {
                        throw error;
                    }
                }
                // Sjekk om manuell delt postboks er angitt
                const manualSharedMailbox = document.getElementById('manualSharedMailbox').value.trim();
                let eventUrl;
                if (manualSharedMailbox) {
                    eventUrl = `https://graph.microsoft.com/v1.0/users/${manualSharedMailbox}/events/${selectedEventId}`;
                } else {
                    eventUrl = `https://graph.microsoft.com/v1.0/me/events/${selectedEventId}`;
                }
                const eventResponse = await fetch(eventUrl, {
                    headers: {
                        Authorization: `Bearer ${tokenResponse.accessToken}`
                    }
                });
                if (!eventResponse.ok) {
                    throw new Error('Kunne ikke hente kalenderhendelse (status ' + eventResponse.status + ')');
                }
                const event = await eventResponse.json();
                if (!event || !event.start) {
                    throw new Error('Kalenderhendelsen mangler nødvendig data.');
                }
                displayMeetingDetails(event); // Display meeting details
                const meetingData = parseGraphEvents([event]);
                // Show the preview table and buttons
                displayPreviewTable(meetingData);
                document.querySelector('.button-container').classList.add('visible'); // Show button container
                document.getElementById('exportTableButton').style.display = 'inline-block';
                document.getElementById('printParticipantListButton').style.display = 'inline-block';
                document.getElementById('updateStatusButton').style.display = 'inline-block';
            } catch (error) {
                console.log(`Feil ved henting av kalenderhendelse: ${error.message}`);
            }
        });

        document.getElementById('updateStatusButton').addEventListener('click', async () => {
            try {
                const selectedEvent = document.querySelector('input[name="event"]:checked');
                if (!selectedEvent) {
                    throw new Error('Velg en kalenderhendelse først.');
                }

                const selectedEventId = selectedEvent.value;
                const account = msalInstance.getActiveAccount();
                let tokenResponse;
                try {
                    tokenResponse = await msalInstance.acquireTokenSilent({
                        scopes: ['Calendars.Read'],
                        account: account
                    });
                } catch (error) {
                    if (error instanceof msal.InteractionRequiredAuthError || error.errorCode === 'consent_required' || error.errorCode === 'interaction_required') {
                        await msalInstance.loginRedirect({
                            scopes: ['User.Read', 'Calendars.Read'],
                            prompt: 'consent',
                            loginHint: account?.username || ''
                        });
                        return;
                    } else {
                        throw error;
                    }
                }

                const graphConfig = {
                    graphMeEndpoint: 'https://graph.microsoft.com/v1.0/me',
                    graphEventsEndpoint: 'https://graph.microsoft.com/v1.0/me/events'
                };

                const eventResponse = await fetch(`${graphConfig.graphEventsEndpoint}/${selectedEventId}`, {
                    headers: {
                        Authorization: `Bearer ${tokenResponse.accessToken}`
                    }
                });

                const event = await eventResponse.json();
                const meetingData = parseGraphEvents([event]);

                // Oppdater forhåndsvisningstabellen med de nyeste dataene
                displayPreviewTable(meetingData);

                console.log('Status oppdatert!');
            } catch (error) {
                console.log(`Feil ved oppdatering av status: ${error.message}`);
            }
        });

        document.getElementById('printParticipantListButton').addEventListener('click', async () => {
            const tableRows = Array.from(document.querySelectorAll('#dataTable tbody tr'))
                .filter(row => row.querySelector('.accepted-checkbox').checked) // Filter only accepted participants
                .map(row => ({
                    firstName: row.cells[1].textContent.trim(), // First name in the second cell
                    lastName: row.cells[2].textContent.trim(),  // Last name in the third cell
                    email: row.cells[10].textContent.trim(),    // Email in the eleventh cell
                    mobile: row.cells[4].textContent.trim()     // Mobile in the fifth cell
                }));

            const statusMessage = document.getElementById('statusMessage');
            if (tableRows.length === 0) {
                statusMessage.textContent = 'Ingen deltakere valgt for utskrift.';
                statusMessage.style.display = 'block';
                return;
            }

            statusMessage.style.display = 'none'; // Hide the status message if participants are selected

            const { jsPDF } = window.jspdf; // Ensure jsPDF is correctly referenced
            const doc = new jsPDF();

            // Add VFK logo to the top-left corner
            const logoPath = 'vfk_logo.png'; // Path to the logo file
            const logoWidth = 50; // Width of the logo in mm
            const logoHeight = 20; // Height of the logo in mm
            doc.addImage(logoPath, 'PNG', 10, 10, logoWidth, logoHeight);

            // Add title
            const meetingTitle = document.getElementById('meetingTitle')?.textContent?.trim() || 'Ingen tittel';
            doc.setFont('Nunito Sans', 'bold');
            doc.setFontSize(16);

            // Split the title into multiple lines if it exceeds the maximum width
            const titleLines = doc.splitTextToSize(meetingTitle, 140); // Set max width to 140mm
            doc.text(titleLines, 105, 35, { align: 'center' }); // Adjust y-coordinate to add more space below the logo

            doc.setFont('Nunito Sans', 'normal');
            doc.setFontSize(18);
            doc.text('Deltakerliste', 105, 50, { align: 'center' }); // Adjust y-coordinate for "Deltakerliste"

            // Add meeting overview in the PDF
            const meetingDate = document.getElementById('meetingDate')?.textContent?.trim() || 'Ukjent dato';
            const meetingStartTime = document.getElementById('meetingStartTime')?.textContent?.trim() || 'Ukjent starttid';
            const meetingEndTime = document.getElementById('meetingEndTime')?.textContent?.trim() || 'Ukjent sluttid';
            const meetingLocation = document.getElementById('meetingLocation')?.textContent?.trim() || 'Ikke spesifisert';
            const meetingOrganizer = document.getElementById('meetingOrganizer')?.textContent?.trim() || 'Ikke spesifisert';

            doc.setFontSize(12);
            doc.setTextColor(0, 82, 96); // Match the primary color
            doc.text('Møteinformasjon', 10, 60); // Adjust y-coordinate for "Møteinformasjon"

            // Add spacing below "Møteinformasjon"
            let currentY = 70; // Start content below "Møteinformasjon" with extra spacing

            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0); // Default text color
            doc.text(`Dato:`, 10, currentY);
            doc.setFont('Nunito Sans', 'bold');
            doc.text(meetingDate, 40, currentY);

            currentY += 10; // Add spacing between rows
            doc.setFont('Nunito Sans', 'normal');
            doc.text(`Tid:`, 10, currentY);
            doc.setFont('Nunito Sans', 'bold');
            doc.text(`${meetingStartTime} til ${meetingEndTime}`, 40, currentY);

            currentY += 10; // Add spacing between rows
            doc.setFont('Nunito Sans', 'normal');
            doc.text(`Sted:`, 10, currentY);
            doc.setFont('Nunito Sans', 'bold');
            doc.text(meetingLocation, 40, currentY);

            currentY += 10; // Add spacing between rows
            doc.setFont('Nunito Sans', 'normal');
            doc.text(`Arrangør:`, 10, currentY);
            doc.setFont('Nunito Sans', 'bold');
            doc.text(meetingOrganizer, 40, currentY);

            currentY += 10; // Add spacing between rows
            doc.setFont('Nunito Sans', 'normal');
            doc.text(`Antall deltakere:`, 10, currentY);
            const acceptedCount = document.getElementById('acceptedCount')?.textContent?.trim() || '0';
            const totalCount = document.getElementById('totalCount')?.textContent?.trim() || '0';
            doc.setFont('Nunito Sans', 'bold');
            doc.text(`${acceptedCount} av ${totalCount} inviterte`, 40, currentY); // Adjusted x-coordinate for alignment

            // Add table with participants
            const tableData = tableRows.map(row => [
                row.firstName,
                row.lastName,
                row.email,
                row.mobile,
                '' // Empty box for "Møtt"
            ]);

            doc.autoTable({
                head: [['Fornavn', 'Etternavn', 'E-post', 'Mobil', 'Møtt']],
                body: tableData,
                startY: currentY + 10, // Add spacing between "Antall deltakere" and the table
                theme: 'grid',
                headStyles: {
                    fillColor: [0, 82, 96],
                    textColor: [255, 255, 255],
                    fontSize: 12,
                    fontStyle: 'bold'
                },
                bodyStyles: {
                    fontSize: 10,
                    textColor: [40, 40, 40],
                    cellPadding: 2, // Add padding inside cells
                    overflow: 'linebreak' // Enable text wrapping
                },
                alternateRowStyles: {
                    fillColor: [242, 246, 247]
                },
                columnStyles: {
                    0: { cellWidth: 40 }, // Fornavn
                    1: { cellWidth: 40 }, // Etternavn
                    2: { cellWidth: 60 }, // E-post
                    3: { cellWidth: 30 }, // Mobil
                    4: { cellWidth: 20 }  // Møtt
                },
                margin: { top: 100 }
            });

            // Add footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(10);
                doc.text(`Side ${i} av ${pageCount}`, 105, 290, { align: 'center' });
            }

            doc.save('Deltakerliste.pdf');
        });

        document.getElementById('logoutButton').addEventListener('click', () => {
            msalInstance.logoutRedirect();
        });

        function parseGraphEvents(events) {
            const participants = events.flatMap(event =>
                event.attendees.map(attendee => {
                    const nameParts = attendee.emailAddress.name.trim().split(' ');
                    return {
                        firstName: nameParts[0],
                        lastName: nameParts.slice(1).join(' '),
                        email: attendee.emailAddress.address,
                        status: attendee.status.response || 'unknown' // Legg til status
                    };
                })
            );
            return {
                startTime: events[0]?.start?.dateTime || 'Ukjent starttid',
                endTime: events[0]?.end?.dateTime || 'Ukjent sluttid',
                participants
            };
        }

        function generateExcel(meetingData) {
            const worksheetData = [
                ['Fornavn', 'Etternavn', 'E-post', 'Starttid', 'Sluttid'],
                ...Array.from(document.querySelectorAll('#dataTable tbody tr'))
                    .filter(row => row.querySelector('.accepted-checkbox').checked)
                    .map(row => [
                        row.cells[0].textContent.trim(),
                        row.cells[1].textContent.trim(),
                        row.cells[2].textContent.trim(),
                        meetingData.startTime,
                        meetingData.endTime
                    ])
            ];
            const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Deltakere');
            const fileName = 'Møtedeltakere.xlsx';
            XLSX.writeFile(workbook, fileName);
            return fileName;
        }

        function toggleAllAccepted(checkbox) {
            // Deaktiver den andre checkboxen hvis denne er valgt
            const other = document.getElementById('toggleAcceptedAndNone');
            if (checkbox.checked) {
                other.checked = false;
                // Marker alle
                const participantCheckboxes = document.querySelectorAll('.accepted-checkbox');
                participantCheckboxes.forEach(cb => cb.checked = true);
            } else {
                // Fjern alle markeringer
                const participantCheckboxes = document.querySelectorAll('.accepted-checkbox');
                participantCheckboxes.forEach(cb => cb.checked = false);
            }
            updateParticipantSummary();
        }

        function toggleAcceptedAndNone(checkbox) {
            // Deaktiver den andre checkboxen hvis denne er valgt
            const other = document.getElementById('toggleAllAccepted');
            if (checkbox.checked) {
                other.checked = false;
                const rows = document.querySelectorAll('#dataTable tbody tr');
                rows.forEach(row => {
                    const status = row.getAttribute('data-status');
                    if ((status === 'accepted' || status === 'none') && status !== 'declined') {
                        row.querySelector('.accepted-checkbox').checked = true;
                    } else {
                        row.querySelector('.accepted-checkbox').checked = false;
                    }
                });
            } else {
                // Fjern alle markeringer
                const participantCheckboxes = document.querySelectorAll('.accepted-checkbox');
                participantCheckboxes.forEach(cb => cb.checked = false);
            }
            updateParticipantSummary();
        }

        function displayPreviewTable(meetingData) {
            const previewTable = document.getElementById('previewTable');
            const participantSummary = document.getElementById('participantSummary');
            const acceptedCountElement = document.getElementById('acceptedCount');
            const notAcceptedCountElement = document.getElementById('notAcceptedCount');

            // Endre: Begge checkboxene i samme kolonne, på samme linje, med lite mellomrom
            const headers = [
                `<div style="display:flex;flex-direction:column;align-items:center;">
                    <span style="font-size:11px;line-height:1.2;margin-bottom:2px;">
                        <span style="white-space:nowrap;">Alle</span> /
                        <span style="white-space:nowrap;">Akseptert+Ingen svar</span>
                    </span>
                    <div style="display:inline-flex;align-items:center;">
                        <input type="checkbox" id="toggleAllAccepted" onclick="toggleAllAccepted(this)" title="Velg alle" style="margin-right:2px;" />
                        <input type="checkbox" id="toggleAcceptedAndNone" onclick="toggleAcceptedAndNone(this)" title="Velg alle som har akseptert eller ikke svart" style="margin-left:2px;" />
                    </div>
                </div>`,
                'Fornavn', 'Etternavn', 'Firma', 'Mobil', 'Nøkkelord', 'Starttid', 'Sluttid', 'Kortnummer', 'Kommentar', 'E-post'
            ];
            const rows = meetingData.participants.map(p => {
                let firstName = p.firstName;
                if (firstName.includes('@')) {
                    firstName = firstName.split('@')[0]; // Extract the portion before '@'
                }

                const firma = p.email.split('@')[1]?.split('.')[0] || 'Ukjent'; // Extract domain name from email
                const isAccepted = p.status === 'accepted'; // Check if status is "Accepted"

                // Adjust start and end times by two hours
                const adjustedStartTime = new Date(meetingData.startTime);
                const adjustedEndTime = new Date(meetingData.endTime);
                adjustedStartTime.setHours(adjustedStartTime.getHours() + 2);
                adjustedEndTime.setHours(adjustedEndTime.getHours() + 2);

                // NY: Legg til data-status attributt for å kunne filtrere på status
                return `
                    <tr data-status="${p.status}">
                        <td><input type="checkbox" class="accepted-checkbox" ${isAccepted ? 'checked' : ''} /></td>
                        <td contenteditable="true">${firstName}</td>
                        <td contenteditable="true">${p.lastName}</td>
                        <td contenteditable="true">${firma}</td>
                        <td contenteditable="true">${p.mobile || ''}</td>
                        <td contenteditable="true"></td>
                        <td>${adjustedStartTime.toLocaleDateString()} ${adjustedStartTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</td>
                        <td>${adjustedEndTime.toLocaleDateString()} ${adjustedEndTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true">${p.email}</td>
                    </tr>
                `;
            }).join('');

            previewTable.innerHTML = `
                <div id="dataTable-container">
                    <table id="dataTable" border="1" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr>${headers.map(header => `<th>${header}</th>`).join('')}</tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            `;
            previewTable.style.display = 'block';

            // Calculate and display participant summary
            const acceptedCount = meetingData.participants.filter(p => p.status === 'accepted').length;
            const notAcceptedCount = meetingData.participants.length - acceptedCount;

            acceptedCountElement.textContent = acceptedCount;
            notAcceptedCountElement.textContent = notAcceptedCount;
            participantSummary.style.display = 'block';

            // Show export and print buttons
            document.getElementById('exportTableButton').style.display = 'inline-block';
            document.getElementById('printParticipantListButton').style.display = 'inline-block';
        }

        function displayMeetingDetails(event) {
            const meetingDetails = document.getElementById('meetingDetails');
            let eventStart = new Date(event.start.dateTime || event.start.date);
            let eventEnd = new Date(event.end.dateTime || event.end.date);

            // Juster tidene med to timer
            eventStart.setHours(eventStart.getHours() + 2);
            eventEnd.setHours(eventEnd.getHours() + 2);

            document.getElementById('meetingTitle').textContent = event.subject || 'Ingen tittel';
            document.getElementById('meetingDate').textContent = eventStart.toLocaleDateString('no-NO');
            document.getElementById('meetingStartTime').textContent = eventStart.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            document.getElementById('meetingEndTime').textContent = eventEnd.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            document.getElementById('meetingLocation').textContent = event.location?.displayName || 'Ikke spesifisert';
            document.getElementById('meetingOrganizer').textContent = event.organizer.emailAddress.name || 'Ikke spesifisert';

            // Update total count of invited participants
            const totalCount = event.attendees?.length || 0;
            document.getElementById('totalCount').textContent = totalCount;

            meetingDetails.style.display = 'block';
        }

        document.getElementById('exportTableButton').addEventListener('click', () => {
            const tableRows = Array.from(document.querySelectorAll('#dataTable tbody tr'))
                .filter(row => row.querySelector('.accepted-checkbox').checked) // Dynamically filter based on "Akseptert" checkbox
                .map(row => Array.from(row.cells).slice(1).map(cell => cell.textContent.trim())); // Exclude the first cell (Akseptert)

            const statusMessage = document.getElementById('statusMessage');
            if (tableRows.length === 0) {
                statusMessage.textContent = 'Ingen deltakere valgt for eksport.';
                statusMessage.style.display = 'block';
                return;
            }

            statusMessage.style.display = 'none'; // Hide the status message if participants are selected

            const headers = Array.from(document.querySelectorAll('#dataTable thead th'))
                .slice(1) // Exclude the first column (Akseptert)
                .map(header => header.textContent.trim());

            const worksheetData = [headers, ...tableRows]; // Combine headers and rows

            const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Deltakere');

            // Fetch title and date from the meeting details
            const meetingTitle = document.getElementById('meetingTitle').textContent.trim() || 'Ingen tittel';
            const meetingDate = document.getElementById('meetingDate').textContent.trim() || 'Ukjent dato';

            // Generate filename
            const fileName = `Deltakerliste ${meetingTitle} - ${meetingDate}.xlsx`.replace(/[/\\?%*:|"<>]/g, ''); // Remove invalid characters

            XLSX.writeFile(workbook, fileName);
        });

        function exportTableToExcel(tableId, filename) {
            const table = document.getElementById(tableId);
            const worksheet = XLSX.utils.table_to_sheet(table);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Deltakere');
            XLSX.writeFile(workbook, filename);
        }

        function updateParticipantSummary() {
            const checkboxes = document.querySelectorAll('.accepted-checkbox');
            const acceptedCount = Array.from(checkboxes).filter(checkbox => checkbox.checked).length;
            const notAcceptedCount = checkboxes.length - acceptedCount;

            document.getElementById('acceptedCount').textContent = acceptedCount;
            document.getElementById('notAcceptedCount').textContent = notAcceptedCount;
        }

        document.addEventListener('change', (event) => {
            if (event.target.classList.contains('accepted-checkbox')) {
                updateParticipantSummary();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            // Ensure buttons are hidden on page load
            document.querySelector('.button-container').style.display = 'none';
            document.getElementById('exportTableButton').style.display = 'none';
            document.getElementById('printParticipantListButton').style.display = 'none';
            document.getElementById('updateStatusButton').style.display = 'none';

            // Allow any date to be selected in the date picker
            const datePicker = document.getElementById('datePicker');
            datePicker.removeAttribute('min'); // Remove any minimum date restriction
            datePicker.removeAttribute('max'); // Remove any maximum date restriction
        });

        document.getElementById('datePicker').addEventListener('change', () => {
            const selectedDate = document.getElementById('datePicker').value;
            const buttonContainer = document.querySelector('.button-container');
            if (selectedDate) {
                buttonContainer.style.display = 'flex'; // Show buttons if a date is selected
            } else {
                buttonContainer.style.display = 'none'; // Hide buttons if no date is selected
                document.getElementById('exportTableButton').style.display = 'none';
                document.getElementById('printParticipantListButton').style.display = 'none';
                document.getElementById('updateStatusButton').style.display = 'none';
            }
        });

        document.getElementById('openCalendarDropdown').addEventListener('click', function() {
            const dropdown = document.getElementById('calendarDropdown');
            dropdown.style.display = dropdown.style.display === 'flex' ? 'none' : 'flex';
        });
        document.getElementById('closeCalendarDropdown').addEventListener('click', function() {
            document.getElementById('calendarDropdown').style.display = 'none';
        });
        // Call the function to load environment variables
        loadEnvVariables();

        const manualSharedMailbox = document.getElementById('manualSharedMailbox');
        const mailboxSuggestion = document.getElementById('mailboxSuggestion');
        const suggestionSentralbord = document.getElementById('suggestionSentralbord');
        const suggestionSkiringssal = document.getElementById('suggestionSkiringssal');
        manualSharedMailbox.addEventListener('focus', function() {
            mailboxSuggestion.style.display = 'block';
        });
        manualSharedMailbox.addEventListener('blur', function() {
            setTimeout(() => mailboxSuggestion.style.display = 'none', 200);
        });
        suggestionSentralbord.addEventListener('mousedown', function(e) {
            e.preventDefault();
            manualSharedMailbox.value = this.textContent;
            mailboxSuggestion.style.display = 'none';
        });
        suggestionSkiringssal.addEventListener('mousedown', function(e) {
            e.preventDefault();
            manualSharedMailbox.value = this.textContent;
            mailboxSuggestion.style.display = 'none';
        });
    </script>
</body>
</html>